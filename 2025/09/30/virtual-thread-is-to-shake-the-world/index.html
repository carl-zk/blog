<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"carl-zk.github.io","root":"/blog/","images":"/blog/images","scheme":"Muse","darkmode":false,"version":"8.25.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/blog/js/config.js" defer></script>

    <meta name="description" content="virtual threadwhen sould you use virtual threadsVirtual threads (introduced in Project Loom, JDK 21 GA) are lightweight threads managed by the JVM rather than the OS. They shine in scenarios where you">
<meta property="og:type" content="article">
<meta property="og:title" content="Virtual Thread Is to Shake the World">
<meta property="og:url" content="https://carl-zk.github.io/blog/2025/09/30/virtual-thread-is-to-shake-the-world/index.html">
<meta property="og:site_name" content="一叶轻舟渡万江">
<meta property="og:description" content="virtual threadwhen sould you use virtual threadsVirtual threads (introduced in Project Loom, JDK 21 GA) are lightweight threads managed by the JVM rather than the OS. They shine in scenarios where you">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-09-30T10:08:17.000Z">
<meta property="article:modified_time" content="2025-10-01T11:12:10.824Z">
<meta property="article:author" content="carl-zk">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://carl-zk.github.io/blog/2025/09/30/virtual-thread-is-to-shake-the-world/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://carl-zk.github.io/blog/2025/09/30/virtual-thread-is-to-shake-the-world/","path":"2025/09/30/virtual-thread-is-to-shake-the-world/","title":"Virtual Thread Is to Shake the World"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Virtual Thread Is to Shake the World | 一叶轻舟渡万江</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/blog/js/utils.js" defer></script><script src="/blog/js/motion.js" defer></script><script src="/blog/js/sidebar.js" defer></script><script src="/blog/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><link rel="alternate" href="/blog/atom.xml" title="一叶轻舟渡万江" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">一叶轻舟渡万江</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">泰山不拒细壤故能成其高 江海不择细流故能就其深</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#virtual-thread"><span class="nav-number">1.</span> <span class="nav-text">virtual thread</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#when-sould-you-use-virtual-threads"><span class="nav-number">1.1.</span> <span class="nav-text">when sould you use virtual threads</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#does-a-%E2%80%9Cvirtual-thread-pool%E2%80%9D-exist"><span class="nav-number">1.2.</span> <span class="nav-text">does a “virtual thread pool” exist?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#How-to-choose-between-pool-of-platform-threads-vs-per-task-virtual-threads"><span class="nav-number">1.3.</span> <span class="nav-text">How to choose between pool of platform threads vs per-task virtual threads</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#VTs-or-Reactor"><span class="nav-number">2.</span> <span class="nav-text">VTs or Reactor</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Reactor-vs-Virtual-threads-different-approaches"><span class="nav-number">2.1.</span> <span class="nav-text">Reactor vs Virtual threads: different approaches</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Reactor"><span class="nav-number">2.1.1.</span> <span class="nav-text">Reactor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Virtual-threads"><span class="nav-number">2.1.2.</span> <span class="nav-text">Virtual threads</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#VTs-or-Netty"><span class="nav-number">3.</span> <span class="nav-text">VTs or Netty</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#VTs-frameworks"><span class="nav-number">4.</span> <span class="nav-text">VTs frameworks</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Caveats-Limitations-amp-Things-to-Watch"><span class="nav-number">5.</span> <span class="nav-text">Caveats, Limitations &amp; Things to Watch</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">carl-zk</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">195</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://carl-zk.github.io/blog/2025/09/30/virtual-thread-is-to-shake-the-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="carl-zk">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一叶轻舟渡万江">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Virtual Thread Is to Shake the World | 一叶轻舟渡万江">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Virtual Thread Is to Shake the World
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-09-30 18:08:17" itemprop="dateCreated datePublished" datetime="2025-09-30T18:08:17+08:00">2025-09-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-10-01 19:12:10" itemprop="dateModified" datetime="2025-10-01T19:12:10+08:00">2025-10-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="virtual-thread"><a href="#virtual-thread" class="headerlink" title="virtual thread"></a>virtual thread</h1><h2 id="when-sould-you-use-virtual-threads"><a href="#when-sould-you-use-virtual-threads" class="headerlink" title="when sould you use virtual threads"></a>when sould you use virtual threads</h2><p>Virtual threads (introduced in <strong>Project Loom</strong>, JDK 21 GA) are lightweight threads managed by the JVM rather than the OS. They shine in scenarios where you need to handle <strong>lots of concurrent tasks that spend most of their time waiting (IO-bound workloads).</strong></p>
<p>Good use cases:</p>
<ul>
<li><p>Servers handling many concurrent connections<br>  e.g., HTTP servers, gRPC servers, WebSocket servers.</p>
</li>
<li><p>High-concurrency clients<br>  e.g., calling many downstream services (DB, REST APIs, message queues).</p>
</li>
<li><p>Asynchronous pipelines<br>  where tasks wait on external systems but you want code to look synchronous.</p>
</li>
<li><p>Replacement for callback-heavy async code<br>  You can write blocking-style code, but still scale like async&#x2F;reactive.</p>
</li>
</ul>
<p>Not ideal:</p>
<ul>
<li><p>CPU-bound parallel computations<br>  Use platform threads (classic ForkJoinPool, parallel streams, or structured concurrency with platform threads). Virtual threads don’t give extra CPU, they just multiplex blocking tasks.</p>
</li>
<li><p>Very short-lived tasks in huge numbers<br>  If the task just increments a counter, spawning millions of VTs gives no benefit and can be slower than batching work on a platform thread pool.</p>
</li>
</ul>
<h2 id="does-a-“virtual-thread-pool”-exist"><a href="#does-a-“virtual-thread-pool”-exist" class="headerlink" title="does a “virtual thread pool” exist?"></a>does a “virtual thread pool” exist?</h2><p>Strictly speaking: <strong>NO, virtual threads don’t use a traditional pool</strong> like <code>Executors.newFixedThreadPool</code>.</p>
<p>Instead, each virtual threads is cheap to create (thousands to millions possible). The JVM schedules them onto a small pool of <strong>carrier threads</strong> (platform threads) behind the scenes.</p>
<p>That means:</p>
<ul>
<li>You can just create anew virtual thread per task (<code>Thread.ofVirtual().start(...)</code> or <code>Executors.newVirtualThreadPerTaskExecutor()</code>).</li>
<li>No need to reuse them —— they are disposable, unlike platform threads.</li>
<li>The JVM maintains an internal scheduler that runs VTs on carrier threads.</li>
</ul>
<p>So the pattern is:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">var</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) &#123;</span><br><span class="line">    IntStream.range(<span class="number">0</span>, <span class="number">1_000_000</span>).forEach(i -&gt;</span><br><span class="line">        executor.submit(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// IO-bound task</span></span><br><span class="line">            fetchFromDb(i);</span><br><span class="line">        &#125;)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here, each task gets its own virtual thread. The JVM multiplexes them efficiently over a small number of OS threads.</p>
<h2 id="How-to-choose-between-pool-of-platform-threads-vs-per-task-virtual-threads"><a href="#How-to-choose-between-pool-of-platform-threads-vs-per-task-virtual-threads" class="headerlink" title="How to choose between pool of platform threads vs per-task virtual threads"></a>How to choose between pool of platform threads vs per-task virtual threads</h2><ul>
<li>User <strong>platform thread pools</strong> when:<ul>
<li>You want to bound concurrency for CPU-bound tasks (e.g., 8 threads for 8 CPU cores).</li>
</ul>
</li>
<li>User virtual threads when:<ul>
<li>You want to scale IO-bound concurrency (e.g., 50k socket connections).</li>
<li>Thread creation overhead is a bottleneck.</li>
</ul>
</li>
</ul>
<h1 id="VTs-or-Reactor"><a href="#VTs-or-Reactor" class="headerlink" title="VTs or Reactor"></a>VTs or Reactor</h1><h2 id="Reactor-vs-Virtual-threads-different-approaches"><a href="#Reactor-vs-Virtual-threads-different-approaches" class="headerlink" title="Reactor vs Virtual threads: different approaches"></a>Reactor vs Virtual threads: different approaches</h2><h3 id="Reactor"><a href="#Reactor" class="headerlink" title="Reactor"></a>Reactor</h3><ul>
<li>Based on the <strong>reactive streams model</strong> (non-blocking, event-loop style).</li>
<li>Forces you to compose async flows (Mono, Flux) to avoid blocking threads.</li>
<li>Good for massive concurrency and <strong>backpressure control</strong>, but requires a different programming model.</li>
</ul>
<h3 id="Virtual-threads"><a href="#Virtual-threads" class="headerlink" title="Virtual threads"></a>Virtual threads</h3><ul>
<li>Keep the <strong>blocking code style</strong> (imperative, linear).</li>
<li>You can just call <code>db.query()</code> or <code>httpClient.send()</code> inside a virtual thread without worring about blocking the OS thread.</li>
<li>The scheduler multiplexes thousands of VTs on a few carriers.</li>
</ul>
<p>In case you have some ideas like </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Mono.fromCallable(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">var</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) &#123;</span><br><span class="line">        <span class="keyword">return</span> executor.submit(() -&gt; blockingDbQuery()).get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>, you could question: <em><strong>why Reactor at all for IO-heavy workloads?</strong></em><br>With VTs, you don’t need reactive chains to achieve scalability ——— <strong>a simple synchronous style in a VT can scale to tens of thousands of connections.</strong></p>
<hr>
<p>Reactor is still useful if:</p>
<ul>
<li>You need backpressure.</li>
<li>You already have a large reactive codebase.</li>
<li>You want integration with libraries that are natively reactive (R2DBC, reactive Kafka, etc.).</li>
</ul>
<p>Hybrid using is fine, you can still integrates with existing Reactor ecosystem.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Scheduler</span> <span class="variable">vtScheduler</span> <span class="operator">=</span> Scheduler.fromExecutor(Executors.newVirtualThreadPerTaskExecutor());</span><br><span class="line"></span><br><span class="line">Mono.fromCallable(() -&gt; blockingApiCall())</span><br><span class="line">    .subscribeOn(vtScheduler)</span><br><span class="line">    .flatMap(result -&gt; Mono.just(transform(result)));</span><br></pre></td></tr></table></figure>

<hr>
<p>it’s a Reactor way you handle IO-heavy request,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Scheduler</span> <span class="variable">vtScheduler</span> <span class="operator">=</span> Scheduler.fromExecutor(</span><br><span class="line">    Executors.newVirtualThreadPerTaskExecutor()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">Mono&lt;String&gt; <span class="title function_">service</span><span class="params">(String id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Mono.fromCallable(() -&gt; blockingDbQuery(id))</span><br><span class="line">               .subscribeOn(vtScheduler)</span><br><span class="line">               .zipWith(</span><br><span class="line">                   Mono.fromCallable(() -&gt; blockingHttpCall(id))</span><br><span class="line">                       .subscribeOn(vtScheduler)</span><br><span class="line">               )</span><br><span class="line">               .map(tuple -&gt; <span class="string">&quot;DB: &quot;</span> + tuple.getT1() + <span class="string">&quot;, HTTP: &quot;</span> + tuple.getT2());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>what does pure virtual threads looks like in IO-heavy tasks?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newVirtualThreadPerTaskExecutor();</span><br><span class="line"></span><br><span class="line">String <span class="title function_">service</span><span class="params">(String id)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Future&lt;String&gt; future = executor.submit(() -&gt; &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">dbResult</span> <span class="operator">=</span> blockingDbQuery(id);</span><br><span class="line">        <span class="type">var</span> <span class="variable">httpResult</span> <span class="operator">=</span> blockingHttpCall(id);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;DB: &quot;</span> + dbResult + <span class="string">&quot;, HTTP: &quot;</span> + httpResult;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> future.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>or with structured concurrency:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">String <span class="title function_">service</span><span class="params">(String id)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">var</span> <span class="variable">scope</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StructuredTaskScope</span>.ShutdownOnFailure()) &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">dbFuture</span> <span class="operator">=</span> scope.fork(() -&gt; blockingDbQuery(id));</span><br><span class="line">        <span class="type">var</span> <span class="variable">httpFuture</span> <span class="operator">=</span> scope.fork(() -&gt; blockingHttpCall(id));</span><br><span class="line"></span><br><span class="line">        scope.join();           <span class="comment">// wait for both</span></span><br><span class="line">        scope.throwIfFailed();  <span class="comment">// propagate exception</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;DB: &quot;</span> + dbFuture.resultNow() + <span class="string">&quot;, HTTP: &quot;</span> + httpFuture.resultNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>that’s it, the blocking style comes back without loose high throughput.</p>
<p>If you’re on Spring 6 &#x2F; Spring boot 3 with Loom (JDK 21), you can drop WebFlux and use Spring MVC with virtual threads instead.<br>Each request gets its own VT, so blocking is cheap:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VirtualThreadConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    ExecutorService <span class="title function_">applicationExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Executors.newVirtualThreadPerTaskExecutor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/service/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">service</span><span class="params">(<span class="meta">@PathVariable</span> String id)</span> &#123;</span><br><span class="line">        <span class="comment">// This method is blocking, but it’s OK — it runs on a virtual thread</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">dbResult</span> <span class="operator">=</span> blockingDbQuery(id);</span><br><span class="line">        <span class="type">var</span> <span class="variable">httpResult</span> <span class="operator">=</span> blockingHttpCall(id);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;DB: &quot;</span> + dbResult + <span class="string">&quot;, HTTP: &quot;</span> + httpResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">blockingDbQuery</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;db-&quot;</span> + id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">blockingHttpCall</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;http-&quot;</span> + id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>this is the “Loom Future”: MVC simplicity + WebFlux scalability.</p>
<h1 id="VTs-or-Netty"><a href="#VTs-or-Netty" class="headerlink" title="VTs or Netty"></a>VTs or Netty</h1><p><strong>Virtual threads can replace the reason Netty exists</strong><br>Netty was designed because the <strong>thread-per-connection model didn’t scale</strong> (too many OS threads).<br>With VTs, you can go back to simple thread-per-connection model:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">var</span> <span class="variable">listener</span> <span class="operator">=</span> AsynchronousServerSocketChannel.open()) &#123;</span><br><span class="line">    listener.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">client</span> <span class="operator">=</span> listener.accept().get(); <span class="comment">// blocks</span></span><br><span class="line">        Thread.ofVirtual().start(() -&gt; handle(client));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Each connection just runs on its own virtual thread ——— no event loop gymnastics.</p>
<blockquote>
<p>this eliminates the core scalability problem Netty solved in 2004.</p>
</blockquote>
<p>Can VTs replace Netty?</p>
<p>Not now, Nety is not “just” about scaling connections. It also provides:</p>
<ul>
<li>Protocol implementations (HTTP, HTTP&#x2F;2, HTTP&#x2F;3, WebSockets, gRPC transport).</li>
<li>Pipelines (handlers, encoders&#x2F;decoders, SSL&#x2F;TLS, compression).</li>
<li>Zero-copy, pooled byte buffers for performance.</li>
<li>Backpressure and flow control.</li>
</ul>
<p>Virtual threads don’t give you any of that ——— they just let you block without guilt.</p>
<p>What’s a minimal blocking HTTP server with VTs looks like?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleHttpServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">var</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">8080</span>)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Server listening on port 8080...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Socket</span> <span class="variable">client</span> <span class="operator">=</span> serverSocket.accept(); <span class="comment">// blocks</span></span><br><span class="line">                Thread.ofVirtual().start(() -&gt; handleClient(client));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleClient</span><span class="params">(Socket client)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (client;</span><br><span class="line">             <span class="type">var</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(client.getInputStream()));</span><br><span class="line">             <span class="type">var</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(client.getOutputStream()))) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Read the first request line (ignore headers for simplicity)</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> reader.readLine();</span><br><span class="line">            System.out.println(<span class="string">&quot;Received: &quot;</span> + line);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Simple HTTP response</span></span><br><span class="line">            writer.write(<span class="string">&quot;HTTP/1.1 200 OK\r\n&quot;</span>);</span><br><span class="line">            writer.write(<span class="string">&quot;Content-Type: text/plain\r\n&quot;</span>);</span><br><span class="line">            writer.write(<span class="string">&quot;Connection: close\r\n&quot;</span>);</span><br><span class="line">            writer.write(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">            writer.write(<span class="string">&quot;Hello from Virtual Threads!\n&quot;</span>);</span><br><span class="line">            writer.flush();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If you want non-blocking channels but still keep the simple style:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NioHttpServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">var</span> <span class="variable">server</span> <span class="operator">=</span> ServerSocketChannel.open()) &#123;</span><br><span class="line">            server.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;NIO server listening on port 8080...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">SocketChannel</span> <span class="variable">client</span> <span class="operator">=</span> server.accept(); <span class="comment">// blocks</span></span><br><span class="line">                Thread.ofVirtual().start(() -&gt; handle(client));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(SocketChannel client)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (client) &#123;</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">            client.read(buffer); <span class="comment">// blocks</span></span><br><span class="line">            buffer.flip();</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                HTTP/1.1 200 OK\r</span></span><br><span class="line"><span class="string">                Content-Type: text/plain\r</span></span><br><span class="line"><span class="string">                Connection: close\r</span></span><br><span class="line"><span class="string">                \r</span></span><br><span class="line"><span class="string">                Hello from Virtual Threads with NIO!</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            client.write(ByteBuffer.wrap(response.getBytes()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="VTs-frameworks"><a href="#VTs-frameworks" class="headerlink" title="VTs frameworks"></a>VTs frameworks</h1><p>Helidon Níma (Helidon 4)</p>
<p>Reactor Core (Spring Reactor &#x2F; WebFlux)</p>
<p>Spring Boot 3.2</p>
<h1 id="Caveats-Limitations-amp-Things-to-Watch"><a href="#Caveats-Limitations-amp-Things-to-Watch" class="headerlink" title="Caveats, Limitations &amp; Things to Watch"></a>Caveats, Limitations &amp; Things to Watch</h1><ul>
<li><strong>Blocking calls in third-party libraries</strong>: If a library internally blocks in a way the JVM can’t detect (e.g. native sleep, synchronized locks), the benefit is diminished.</li>
<li><strong>ThreadLocal usage</strong>: Because you may have many virtual threads, ThreadLocal data may become an issue (memory, leakage). Scoped values or other strategies are recommended. </li>
<li><strong>Resource limits beyond threads</strong>: Database connections, file descriptors, sockets, memory — you still need to manage these.</li>
<li><strong>Performance &amp; tuning</strong>: The new runtime behaviors may reveal new performance bottlenecks, GC overheads, scheduling latency, etc.</li>
<li><strong>Maturity &amp; ecosystem</strong>: Many frameworks, tools, APM agents, debuggers, etc., will need adaptation to fully embrace Loom.</li>
</ul>
<p>ThreadLocals can blow up memory usage with millions of virtual threads.<br>Prefer Scoped Values (available in preview) or explicit context passing.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ScopedValue&lt;String&gt; USER = ScopedValue.newInstance();</span><br><span class="line"></span><br><span class="line">ScopedValue.where(USER, <span class="string">&quot;carl&quot;</span>)</span><br><span class="line">           .run(() -&gt; doWork(USER.get()));</span><br></pre></td></tr></table></figure>

<p>Structured Concurrency (for Task Groups), Instead of manual <code>CompletableFuture</code> composition, use Loom’s structured concurrency API:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">var</span> <span class="variable">scope</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StructuredTaskScope</span>.ShutdownOnFailure()) &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">task1</span> <span class="operator">=</span> scope.fork(() -&gt; fetchUser());</span><br><span class="line">    <span class="type">var</span> <span class="variable">task2</span> <span class="operator">=</span> scope.fork(() -&gt; fetchOrders());</span><br><span class="line">    scope.join();</span><br><span class="line">    scope.throwIfFailed();</span><br><span class="line">    <span class="keyword">return</span> combine(task1.resultNow(), task2.resultNow());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>🗓 Project Loom Timeline &#x2F; Roadmap<br>🔹 Early Days</p>
<p>2017: Project Loom was announced at OpenJDK (Brian Goetz &amp; Ron Pressler leading).</p>
<p>2018–2020: Early prototypes with fibers and continuations. APIs unstable.</p>
<p>JDK 13–16: Some incubator APIs for continuations and structured concurrency experiments.</p>
<p>🔹 Key Milestones</p>
<p>JDK 19 (Sept 2022)</p>
<p>Virtual Threads introduced as a preview feature.</p>
<p>Structured Concurrency incubated.</p>
<p>JDK 20 (Mar 2023)</p>
<p>Virtual Threads previewed again with refinements.</p>
<p>Structured Concurrency incubator updated.</p>
<p>JDK 21 (Sept 2023, LTS release)</p>
<p>Virtual Threads finalized (no longer preview).</p>
<p>Structured Concurrency still incubating.</p>
<p>Scoped Values introduced in preview.</p>
<p>JDK 22 (Mar 2024)</p>
<p>Structured Concurrency (2nd incubator round).</p>
<p>Scoped Values (2nd preview).</p>
<p>JDK 23 (Sept 2024, not LTS)</p>
<p>Ongoing improvements in Structured Concurrency &amp; Scoped Values.</p>
<p>Tooling support (debuggers, profilers) improving for virtual threads.</p>
<p>🔮 Near Future</p>
<p>JDK 25 (likely next LTS in 2026)</p>
<p>Expect Structured Concurrency and Scoped Values to become stable.</p>
<p>Virtual thread ecosystem maturity (Spring, Hibernate, Netty alternatives adapting).</p>
<p>JVM &#x2F; JIT &#x2F; GC optimizations specific to Loom workloads.</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/blog/2025/09/28/projectreactor-webflux/" rel="prev" title="Projectreactor &amp; Webflux">
                  <i class="fa fa-angle-left"></i> Projectreactor & Webflux
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">carl-zk</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/carl-zk" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
